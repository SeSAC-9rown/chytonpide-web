<main class="flex-1 p-6 pb-24 md:pb-6 md:ml-64">
  <div class="max-w-md mx-auto mt-12">
    <div class="bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">ë””ë°”ì´ìŠ¤ ë“±ë¡</h2>
      <p class="text-sm text-gray-600 text-center mb-6">í™”ë¶„ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>
      
      <!-- QR ì½”ë“œ ìŠ¤ìº” ì˜ì—­ í‘œì‹œ -->
      <div class="mb-6 p-4 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center h-48">
        <div class="text-center">
          <svg class="w-16 h-16 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <p class="text-gray-600 text-sm">ì¹´ë©”ë¼ ìŠ¤ìº” ì¤€ë¹„ ì¤‘...</p>
        </div>
      </div>
      
      <!-- ì¹´ë©”ë¼ ì—´ê¸° ë²„íŠ¼ -->
      <button 
        id="scan-qr-btn"
        class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition mb-3">
        ğŸ“· QR ì½”ë“œ ìŠ¤ìº”
      </button>
      
      <!-- ìˆ˜ë™ ì…ë ¥ ì˜ì—­ (ì„ íƒì‚¬í•­) -->
      <div class="border-t pt-4 mt-4">
        <p class="text-sm text-gray-600 mb-3">ë˜ëŠ” ì§ì ‘ ì…ë ¥</p>
        <input 
          type="text" 
          id="serial-input" 
          placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: CHY3343)"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-600 mb-3">
        <button 
          id="manual-submit-btn"
          class="w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
          ë“±ë¡
        </button>
      </div>
      
      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="loading" class="hidden mt-4 text-center">
        <p class="text-gray-600">ë“±ë¡ ì¤‘...</p>
      </div>
      
      <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
      <div id="message" class="mt-4 p-3 rounded-lg hidden text-sm text-center font-semibold"></div>
    </div>
  </div>
</main>

<script>
  // QR ì½”ë“œ ìŠ¤ìº” ë²„íŠ¼ í´ë¦­
  document.getElementById('scan-qr-btn').addEventListener('click', async () => {
    try {
      // iOS 13+, Android ëª¨ë˜ ë¸Œë¼ìš°ì €ìš© QR ì½”ë“œ ìŠ¤ìº”
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      
      // ê°„ë‹¨í•œ ì¹´ë©”ë¼ í™œì„±í™” (ì‹¤ì œ QR ì½”ë“œ ë””ì½”ë”©ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš”)
      // ì—¬ê¸°ì„œëŠ” ì‚¬ìš©ìê°€ ì‹œë¦¬ì–¼ì„ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì „ì†¡í•˜ë„ë¡ ì„¤ì •
      alert('ì¹´ë©”ë¼ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ QRì„ ìŠ¤ìº”í•˜ì„¸ìš”.');
      
      // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
      stream.getTracks().forEach(track => track.stop());
    } catch (error) {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
      alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
  });

  // ìˆ˜ë™ ë“±ë¡ ë²„íŠ¼
  document.getElementById('manual-submit-btn').addEventListener('click', registerDevice);
  
  // Enter í‚¤ë¡œë„ ë“±ë¡ ê°€ëŠ¥
  document.getElementById('serial-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') registerDevice();
  });

  // ë””ë°”ì´ìŠ¤ ë“±ë¡ í•¨ìˆ˜
  async function registerDevice() {
    const serial = document.getElementById('serial-input').value.trim();
    
    if (!serial) {
      showMessage('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
      return;
    }
    
    const loading = document.getElementById('loading');
    const messageDiv = document.getElementById('message');
    
    loading.classList.remove('hidden');
    messageDiv.classList.add('hidden');
    
    try {
      const response = await fetch(`<%= user_device_path(current_user) %>`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          device: { serial: serial }
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showMessage('âœ… ' + data.message, 'success');
        document.getElementById('serial-input').value = '';
        
        // 2ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        setTimeout(() => {
          window.location.href = '<%= root_path %>';
        }, 2000);
      } else {
        showMessage('âŒ ' + data.message, 'error');
      }
    } catch (error) {
      console.error('ë“±ë¡ ì˜¤ë¥˜:', error);
      showMessage('âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    } finally {
      loading.classList.add('hidden');
    }
  }

  // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
    
    if (type === 'success') {
      messageDiv.classList.add('bg-green-100', 'text-green-800');
    } else {
      messageDiv.classList.add('bg-red-100', 'text-red-800');
    }
  }
</script>