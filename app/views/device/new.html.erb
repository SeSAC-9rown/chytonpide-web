<body>
  <div class="max-w-md mx-auto mt-12">
    <div class="bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">ë””ë°”ì´ìŠ¤ ë“±ë¡</h2>
      <p class="text-sm text-gray-600 text-center mb-6">QR ìŠ¤ìº” ë˜ëŠ” ì§ì ‘ ì…ë ¥</p>

      <input 
        type="file" 
        id="camera-input" 
        accept="image/*" 
        capture="environment"
        class="hidden">

      <button
        id="camera-btn"
        class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition mb-4">
        ğŸ“· ì¹´ë©”ë¼ë¡œ QR ì´¬ì˜
      </button>

      <input
        type="text"
        id="serial-input"
        placeholder="ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì…ë ¥"
        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-600 mb-3">

      <button
        id="submit-btn"
        class="w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
        ë“±ë¡
      </button>

      <div id="message" class="mt-4 text-sm text-center text-gray-700 font-semibold"></div>
      
      <!-- ë””ë²„ê¹… ì •ë³´ -->
      <div id="debug-info" class="mt-6 p-4 bg-gray-100 rounded text-xs font-mono hidden max-h-48 overflow-y-auto">
        <div class="font-bold mb-2 text-gray-800">ğŸ” ë””ë²„ê·¸:</div>
        <div id="debug-log" class="text-gray-700 whitespace-pre-wrap"></div>
      </div>

      <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
      <div id="preview-container" class="mt-4 text-center hidden">
        <img id="preview-img" src="" class="max-w-full border rounded" style="max-height: 200px;">
      </div>
    </div>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
  (function() {
    const cameraBtn      = document.getElementById('camera-btn');
    const cameraInput    = document.getElementById('camera-input');
    const serialInput    = document.getElementById('serial-input');
    const submitBtn      = document.getElementById('submit-btn');
    const messageDiv     = document.getElementById('message');
    const debugDiv       = document.getElementById('debug-info');
    const debugLog       = document.getElementById('debug-log');
    const previewImg     = document.getElementById('preview-img');
    const previewContainer = document.getElementById('preview-container');

    let isProcessing = false;

    function log(msg) {
      console.log(msg);
      debugLog.textContent += msg + '\n';
      debugDiv.classList.remove('hidden');
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function clearDebug() {
      debugLog.textContent = '';
      previewContainer.classList.add('hidden');
    }

    function showMessage(msg) {
      messageDiv.textContent = msg;
    }

    // ğŸ”§ jsQR ê³µì‹ ë°©ì‹ (ë‹¨ìˆœí•˜ê³  ëª…í™•)
    function decodeQRFromImage(img) {
      try {
        // 1. Canvas ìƒì„± ë° ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          log('âŒ Canvas 2D context íšë“ ì‹¤íŒ¨');
          return null;
        }

        ctx.drawImage(img, 0, 0);
        log(`âœ“ Canvas: ${canvas.width}x${canvas.height}px`);

        // 2. ImageData ì¶”ì¶œ (ê³µì‹ ë¬¸ì„œ ë°©ì‹)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        log(`âœ“ ImageData: ${imageData.data.length} bytes`);

        // 3. jsQR ì‹¤í–‰ (ì›ë³¸ imageData ì‚¬ìš©)
        log('â³ jsQR ì²˜ë¦¬ ì¤‘...');
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          log(`âœ… QR ê°ì§€: ${code.data}`);
          return code.data;
        } else {
          log('âŒ QR ì½”ë“œ ë¯¸ê°ì§€');
          return null;
        }
      } catch (err) {
        log(`âŒ ì˜¤ë¥˜: ${err.message}`);
        console.error(err);
        return null;
      }
    }

    // ğŸ”§ ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
    function resizeImage(img) {
      const MAX_DIMENSION = 1000;
      
      if (img.width <= MAX_DIMENSION && img.height <= MAX_DIMENSION) {
        log(`âœ“ ì´ë¯¸ì§€ í¬ê¸° OK (${img.width}x${img.height})`);
        return img;
      }

      log(`ğŸ“ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ: ${img.width}x${img.height} â†’ `, false);

      const ratio = img.width / img.height;
      let newWidth, newHeight;

      if (img.width > img.height) {
        newWidth = MAX_DIMENSION;
        newHeight = Math.round(MAX_DIMENSION / ratio);
      } else {
        newHeight = MAX_DIMENSION;
        newWidth = Math.round(MAX_DIMENSION * ratio);
      }

      log(`${newWidth}x${newHeight}`);

      const canvas = document.createElement('canvas');
      canvas.width = newWidth;
      canvas.height = newHeight;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, newWidth, newHeight);

      // Canvasë¥¼ Imageë¡œ ë³€í™˜
      const resizedImg = new Image();
      resizedImg.src = canvas.toDataURL();
      
      return new Promise((resolve) => {
        resizedImg.onload = () => {
          resolve(resizedImg);
        };
      });
    }

    cameraBtn.addEventListener('click', () => {
      if (isProcessing) return;
      clearDebug();
      cameraInput.click();
    });

    cameraInput.addEventListener('change', async (e) => {
      if (isProcessing) return;
      isProcessing = true;

      const file = e.target.files[0];
      if (!file) {
        showMessage('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        isProcessing = false;
        return;
      }

      clearDebug();
      showMessage('QR ì½”ë“œ ì¸ì‹ ì¤‘...');
      log(`ğŸ“ íŒŒì¼: ${file.name}`);
      log(`ğŸ’¾ í¬ê¸°: ${(file.size / 1024 / 1024).toFixed(2)}MB`);

      const reader = new FileReader();
      
      reader.onerror = () => {
        log('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
        showMessage('âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        isProcessing = false;
      };

      reader.onload = (event) => {
        const img = new Image();
        
        img.onerror = () => {
          log('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
          showMessage('âŒ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          isProcessing = false;
        };

        img.onload = async () => {
          try {
            log(`ğŸ–¼ï¸ ì›ë³¸ ì´ë¯¸ì§€: ${img.width}x${img.height}px`);

            // ë¯¸ë¦¬ë³´ê¸°
            previewImg.src = img.src;
            previewContainer.classList.remove('hidden');

            // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
            const processedImg = await resizeImage(img);

            log('---');

            // QR ë””ì½”ë“œ
            const qrData = decodeQRFromImage(processedImg);

            if (qrData) {
              serialInput.value = qrData;
              showMessage('âœ… QR ì¸ì‹ ì„±ê³µ!');
              log('---');
              log('âœ¨ ë“±ë¡ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            } else {
              showMessage('âŒ QR ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              log('---');
              log('ğŸ’¡ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”:');
              log('   â€¢ QR ì½”ë“œê°€ ëª…í™•í•œê°€?');
              log('   â€¢ QR ì½”ë“œê°€ ì •ë©´ì¸ê°€?');
              log('   â€¢ ì¡°ëª…ì´ ì¶©ë¶„í•œê°€?');
            }

            cameraInput.value = '';
            isProcessing = false;
          } catch (err) {
            log(`âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: ${err.message}`);
            console.error(err);
            showMessage('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            isProcessing = false;
          }
        };

        img.src = event.target.result;
      };

      reader.readAsDataURL(file);
    });

    submitBtn.addEventListener('click', async () => {
      const serial = serialInput.value.trim();
      if (!serial) {
        showMessage('ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      try {
        const res = await fetch('/users/<%= current_user.id %>/device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({ device: { serial: serial } })
        });

        const data = await res.json();

        if (res.ok && data.success) {
          showMessage('âœ… ' + data.message);
          serialInput.value = '';
          setTimeout(() => {
            window.location.href = '<%= root_path %>';
          }, 1500);
        } else {
          showMessage('âŒ ' + (data.message || 'ë“±ë¡ ì‹¤íŒ¨'));
        }
      } catch (e) {
        console.error(e);
        showMessage('âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  })();
</script>
