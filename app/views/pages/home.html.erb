<% content_for :styles do %>
  <%= stylesheet_link_tag "reset" %>
  <%= stylesheet_link_tag "variables" %>
  <%= stylesheet_link_tag "typography" %>
  <%= stylesheet_link_tag "home" %>
  <%= stylesheet_link_tag "mobile" %>
<% end %>

<div class="home-page home-day" id="home-container">
  <!-- Background Image -->
  <%= image_tag "home/day-background.png", alt: "ë‚® ë°°ê²½", class: "home-background", id: "home-bg" %>
  
  <!-- ì¹˜í”¼ ìºë¦­í„° (ë””ë°”ì´ìŠ¤ ìˆì„ ë•Œë§Œ) -->
  <% if current_user.device.present? %>
    <div class="chipi-fixed">
      <%= image_tag "chipi/chipi-day.png", alt: "ì¹˜í”¼", class: "chipi-fixed-img", id: "chipi-img" %>
    </div>
  <% end %>
  
  <!-- Main Content -->
  <div class="home-content">
    <% if current_user.device.present? %>
      <div>
        <!-- ì˜¨ë„/ìŠµë„ ì¹´ë“œ -->
        <div class="info-cards">
          <div class="info-card temp-card">
            <div class="card-label">ì˜¨ë„</div>
            <div class="card-value">
              <span class="value-number" id="sensor-temperature">24</span>
              <span class="value-unit">Â°C</span>
            </div>
            <div class="card-status status-good">ì ë‹¹í•´ìš”</div>
          </div>

          <div class="info-card humidity-card">
            <div class="card-label">ìŠµë„</div>
            <div class="card-value">
              <span class="value-number" id="sensor-humidity">55</span>
              <span class="value-unit">%</span>
            </div>
            <div class="card-status status-warning">ê±´ì¡°í•´ìš”</div>
          </div>
        </div>
        
        <!-- ë¬¼ì£¼ê¸°/ì˜ì–‘ì œ ì¹´ë“œ -->
        <div class="care-cards">
          <div class="care-card water-card">
            <div class="care-icon">ğŸ’§</div>
            <div class="care-info">
              <div class="care-label">ë¬¼ ì£¼ê¸°</div>
              <div class="care-value">
                <% watering_interval_days = current_user.device.kit.watering_interval_days %>
                <% watering_d_days = (watering_interval_days - ((Date.current - current_user.device.kit.planted_at).to_i % watering_interval_days)) % watering_interval_days %>
                <%= watering_d_days.zero? ? "D-day" : "D-" + watering_d_days.to_s %>
              </div>
            </div>
          </div>

          <div class="care-card nutrient-card">
            <div class="care-icon">ğŸŒ¿</div>
            <div class="care-info">
              <div class="care-label">ì˜ì–‘ì œ</div>
              <div class="care-value">
                <% fertilizer_interval_days = current_user.device.kit.fertilizer_interval_days %>
                <% fertilizer_d_days = (fertilizer_interval_days - ((Date.current - current_user.device.kit.planted_at).to_i % fertilizer_interval_days)) % fertilizer_interval_days %>
                <%= fertilizer_d_days.zero? ? "D-day" : "D-" + fertilizer_d_days.to_s %>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="light-control-wrapper">
        <!-- ì¡°ëª… ì»¨íŠ¸ë¡¤ ì¹´ë“œ -->
        <div class="light-control-card">
          <div class="light-header">
            <div class="light-icon">â˜€ï¸</div>
            <span class="light-title">ì‹ë¬¼ ì„±ì¥ ì¡°ëª…</span>
            <span class="light-status" id="led-mode"><%= current_user.device.led_mode %></span>
          </div>
          <div class="light-buttons">
            <button id="btn-on"
                class="light-btn light-btn-on <%= 'active' if current_user.device.led_mode == 'ON' %>"
                data-led-mode="ON">
              ON
            </button>
            <button id="btn-off"
                class="light-btn light-btn-off <%= 'active' if current_user.device.led_mode == 'OFF' %>"
                data-led-mode="OFF">
              OFF
            </button>
            <button id="btn-auto"
                class="light-btn light-btn-auto <%= 'active' if current_user.device.led_mode == 'AUTO' %>"
                data-led-mode="AUTO">
              AUTO
            </button>
          </div>
        </div>
      </div>
      
      <script>
        (function() {
          const userId  = <%= current_user.id %>;
          const csrfTok = document.querySelector('meta[name="csrf-token"]').content;

          const homeContainer = document.getElementById('home-container');
          const homeBg        = document.getElementById('home-bg');
          const chipiImg      = document.getElementById('chipi-img');

          function updateTheme(ledMode) {
            if (ledMode === 'OFF') {
              // Night ëª¨ë“œ
              homeContainer.classList.remove('home-day');
              homeContainer.classList.add('home-night');
              homeBg.src = '<%= asset_path("home/night-background.png") %>';
              homeBg.alt = 'ë°¤ ë°°ê²½';
              if (chipiImg) {
                chipiImg.src = '<%= asset_path("chipi/chipi-night.png") %>';
                chipiImg.alt = 'ì¹˜í”¼ ë°¤';
              }
            } else {
              // Day ëª¨ë“œ (ON, AUTO)
              homeContainer.classList.remove('home-night');
              homeContainer.classList.add('home-day');
              homeBg.src = '<%= asset_path("home/day-background.png") %>';
              homeBg.alt = 'ë‚® ë°°ê²½';
              if (chipiImg) {
                chipiImg.src = '<%= asset_path("chipi/chipi-day.png") %>';
                chipiImg.alt = 'ì¹˜í”¼ ë‚®';
              }
            }
          }

          async function updateDevice(ledMode, isLedOn, lcdFace) {
            const params = new URLSearchParams();
            params.append('led_mode', ledMode);
            params.append('is_led_on', isLedOn);
            params.append('lcd_face', lcdFace);

            const res = await fetch(`/users/${userId}/device`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                'X-CSRF-Token': csrfTok
              },
              body: params.toString()
            });

            const data = await res.json();
            console.log('PATCH result', res.status, data);

            if (res.ok && data.status === 'success') {
              document.getElementById('led-mode').textContent = ledMode;
              setLedButtonsUI(ledMode);
              updateTheme(ledMode); // í…Œë§ˆ ì „í™˜
            } else {
              alert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          }

          function setLedButtonsUI(mode) {
            const onBtn   = document.getElementById('btn-on');
            const offBtn  = document.getElementById('btn-off');
            const autoBtn = document.getElementById('btn-auto');

            const reset = (btn) => {
              btn.classList.remove('active');
            };

            [onBtn, offBtn, autoBtn].forEach(reset);

            if (mode === 'ON') {
              onBtn.classList.add('active');
            } else if (mode === 'OFF') {
              offBtn.classList.add('active');
            } else if (mode === 'AUTO') {
              autoBtn.classList.add('active');
            }
          }

          document.addEventListener('turbo:load', () => {
            const currentMode = '<%= current_user.device.led_mode %>';
            setLedButtonsUI(currentMode);
            updateTheme(currentMode); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í…Œë§ˆ ì„¤ì •

            document.getElementById('btn-on').addEventListener('click', () => {
              updateDevice('ON', 'true', 'HAPPY');
            });

            document.getElementById('btn-off').addEventListener('click', () => {
              updateDevice('OFF', 'false', 'SAD');
            });

            document.getElementById('btn-auto').addEventListener('click', () => {
              updateDevice('AUTO', 'true', 'NEUTRAL');
            });
          });
        })();
      </script>
    <% else %>
      <div class="no-device-message">
        <div class="no-device-icon">ğŸ“±</div>
        <h2 class="no-device-title">ë“±ë¡ëœ ë””ë°”ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
        <p class="no-device-description">ì²« ë²ˆì§¸ í™”ë¶„ ì¹œêµ¬ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
        <%= link_to "ë””ë°”ì´ìŠ¤ ë“±ë¡", new_user_device_path(current_user), class: "no-device-btn" %>
      </div>
    <% end %>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <%= link_to log_path, class: "nav-item" do %>
      <%= image_tag "common/icons/nav-diary.svg", alt: "ì„±ì¥ì¼ì§€", class: "nav-icon" %>
      <div class="nav-label">ì„±ì¥ì¼ì§€</div>
    <% end %>
    <%= link_to root_path, class: "nav-item active" do %>
      <%= image_tag "common/icons/nav-home.svg", alt: "í™ˆ", class: "nav-icon" %>
      <div class="nav-label">í™ˆ</div>
    <% end %>
    <%= link_to mypage_path, class: "nav-item" do %>
      <%= image_tag "common/icons/nav-mypage.svg", alt: "ë§ˆì´í˜ì´ì§€", class: "nav-icon" %>
      <div class="nav-label">ë§ˆì´í˜ì´ì§€</div>
    <% end %>
  </nav>
</div>
